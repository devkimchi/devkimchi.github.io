<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    
    <title>Service Broker External Activator for SQL Server Step by Step #2 | DevKimchi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="keywords" content="SQL Server,External Activator,Service Broker" />
    
    <meta name="description" content="From the previous post, Step 1: Service Broker External Activator Service Setup, we have installed a Windows Service application for Service Broker External Activator (EA). In this article, we are goi">
<meta property="og:type" content="article">
<meta property="og:title" content="Service Broker External Activator for SQL Server Step by Step #2">
<meta property="og:url" content="http://devkimchi.com/2014/11/08/service-broker-external-activator-for-sql-server-step-by-step-2/index.html">
<meta property="og:site_name" content="DevKimchi">
<meta property="og:description" content="From the previous post, Step 1: Service Broker External Activator Service Setup, we have installed a Windows Service application for Service Broker External Activator (EA). In this article, we are goi">
<meta property="og:image" content="http://blob.devkimchi.com/devkimchiwp/2014/11/SSBEAS.Install.03.png">
<meta property="og:updated_time" content="2016-09-13T12:11:48.430Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Service Broker External Activator for SQL Server Step by Step #2">
<meta name="twitter:description" content="From the previous post, Step 1: Service Broker External Activator Service Setup, we have installed a Windows Service application for Service Broker External Activator (EA). In this article, we are goi">
<meta name="twitter:image" content="http://blob.devkimchi.com/devkimchiwp/2014/11/SSBEAS.Install.03.png">
    

    
        <link rel="alternate" href="/atom.xml" title="DevKimchi" type="application/atom+xml" />
    

    
        <link rel="icon" href="/favicon.ico" />
    

    <link rel="stylesheet" href="/vendor/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/vendor/titillium-web/styles.css">
    <link rel="stylesheet" href="/vendor/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/vendor/jquery/2.0.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/vendor/lightgallery/css/lightgallery.min.css">
    
    
        <script type="text/javascript">
(function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-54189949-1', 'auto');
ga('send', 'pageview');

</script>
    
    

</head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                        <h2 class="subtitle-wrap">
                            <p class="subtitle">Fermentation: Turning MS Tech Stack, .NET and Web into Something</p>
                        </h2>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">Home</a>
                                </li>
                            
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="http://devkimchi.com"></form>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/Uncategorized/">Uncategorized</a>
    </h1>
</div>
                        <div class="main-body-content">
                            <article id="post-service-broker-external-activator-for-sql-server-step-by-step-2" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        Service Broker External Activator for SQL Server Step by Step #2
        </h1>
    

            </header>
        
        
            <div class="article-subtitle">
                <a href="/2014/11/08/service-broker-external-activator-for-sql-server-step-by-step-2/" class="article-date">
    <time datetime="2014-11-08T10:55:21.000Z" itemprop="datePublished">2014-11-08</time>
</a>
                
    <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/External-Activator/">External Activator</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SQL-Server/">SQL Server</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Service-Broker/">Service Broker</a></li></ul>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <p>From the previous post, <a href="http://devkimchi.com/811/service-broker-external-activator-for-sql-server-step-by-step-1/">Step 1: Service Broker External Activator Service Setup</a>, we have installed a Windows Service application for Service Broker External Activator (EA). In this article, we are going to setup SQL Server to enable Service Broker (SB).</p>
<p>Its sample source codes can be found at: <a href="https://github.com/devkimchi/Service-Broker-External-Activator" target="_blank" rel="external">devkimchi/Service-Broker-External-Activator</a></p>
<blockquote>
<ul>
<li><a href="http://devkimchi.com/811/service-broker-external-activator-for-sql-server-step-by-step-1/">Step 1: Service Broker External Activator Service Setup</a></li>
<li><strong>Step 2: SQL Server Setup</strong></li>
<li><a href="http://devkimchi.com/891/service-broker-external-activator-for-sql-server-step-by-step-3/">Step 3: External Activator Application Development</a></li>
<li><a href="http://devkimchi.com/951/service-broker-external-activator-for-sql-server-step-by-step-4/">Step 4: External Activator Service Configuration</a></li>
<li><a href="http://devkimchi.com/1051/service-broker-external-activator-for-sql-server-step-by-step-5/">Step 5: Putting Them Altogether</a></li>
</ul>
</blockquote>
<h2 id="SQL-Server-Setup-for-Service-Broker"><a href="#SQL-Server-Setup-for-Service-Broker" class="headerlink" title="SQL Server Setup for Service Broker"></a>SQL Server Setup for Service Broker</h2><blockquote>
<p><strong>Business Requirements</strong>:</p>
<p>  We are about to trace product details changes. As soon as a product is added, updated, or deleted, those change details should be logged in a separated database and table so that the log table can be utilised for other purpose.</p>
</blockquote>
<p>Firstly, we need to create two databases &ndash; <code>SourceDB</code> for source that contains product details and <code>TrackingDB</code> for tracking that stored log details.</p>
<h3 id="Creating-Databases"><a href="#Creating-Databases" class="headerlink" title="Creating Databases"></a>Creating Databases</h3><pre><code>USE [master]
GO

CREATE DATABASE [SourceDB]
GO

CREATE DATABASE [TrackingDB]
GO
`&lt;/pre&gt;

### Creating Tables

Once both databases are created, each database needs a table respectively &amp;ndash; `Products` on `SourceDB` and `TrackingLogs` on `TrackingDB`.

&lt;pre&gt;`USE [SourceDB]
GO

CREATE TABLE [dbo].[Products] (
    [ProductId]     [int]           IDENTITY(1,1)   NOT NULL,
    [Name]          [nvarchar](50)                  NOT NULL,
    [Description]   [nvarchar](50)                  NULL,
    [Price]         [decimal](18, 2)                NOT NULL,
    CONSTRAINT [PK_Products] PRIMARY KEY CLUSTERED (
        [ProductId] ASC
    ) WITH (
        PAD_INDEX = OFF,
        STATISTICS_NORECOMPUTE = OFF,
        IGNORE_DUP_KEY = OFF,
        ALLOW_ROW_LOCKS = ON,
        ALLOW_PAGE_LOCKS = ON
    ) ON [PRIMARY]
) ON [PRIMARY]
GO

USE [TrackingDB]
GO

CREATE TABLE [dbo].[TrackingLogs] (
    [TrackingLogId] [int]           IDENTITY(1,1)   NOT NULL,
    [Source]        [nvarchar](50)                  NOT NULL,
    [Field]         [nvarchar](50)                  NOT NULL,
    [TrackingType]  [nvarchar](8)                   NOT NULL,
    [OldValue]      [nvarchar](MAX)                 NULL,
    [NewValue]      [nvarchar](MAX)                 NULL,
    CONSTRAINT [PK_TrackingLogs] PRIMARY KEY CLUSTERED (
        [TrackingLogId] ASC
    ) WITH (
        PAD_INDEX = OFF,
        STATISTICS_NORECOMPUTE = OFF,
        IGNORE_DUP_KEY = OFF,
        ALLOW_ROW_LOCKS = ON,
        ALLOW_PAGE_LOCKS = ON
    ) ON [PRIMARY]
) ON [PRIMARY]
GO
`&lt;/pre&gt;

&lt;a name=&quot;creating-stored-procedures&quot;&gt;&lt;/a&gt;

### Creating Stored Procedures

We have just created two tables. So far so good. Now, we are going to create stored procedures. They will send messages to EA or receive messages from EA.

&lt;pre&gt;`USE [SourceDB]
GO

CREATE PROCEDURE [usp_SendTrackingRequest]
    @productId      AS INT,
    @trackingType   AS NVARCHAR(8),
    @inserted       AS XML,
    @deleted        AS XML
AS
BEGIN

    SET NOCOUNT ON;

    DECLARE @data    AS XML

    SET @data = (SELECT
                    @productId              AS ProductId,
                    @trackingType           AS TrackingType,
                    COALESCE(@inserted, &apos;&apos;) AS Inserted,
                    COALESCE(@deleted, &apos;&apos;)  AS Deleted
                 FOR XML PATH(&apos;&apos;), ROOT(&apos;Changes&apos;), ELEMENTS)

    DECLARE @handle    AS UNIQUEIDENTIFIER

    BEGIN DIALOG CONVERSATION @handle  
        FROM
            SERVICE [TrackingInitiatorService]
        TO
            SERVICE &apos;TrackingTargetService&apos;
        ON
            CONTRACT [TrackingContract]
        WITH
            ENCRYPTION = OFF;

    SEND
        ON CONVERSATION @handle
        MESSAGE TYPE [TrackingRequest] (@data)

END
GO
`&lt;/pre&gt;
</code></pre><ul>
<li>This stored procedure is called by triggers when <code>INSERT</code>, <code>UPDATE</code> or <code>DELETE</code> action occurs.</li>
<li>The triggers passes inserted/deleted records to the stored procedure.</li>
<li>The stored procedure wraps passed values in an XML format.</li>
<li><p>Then the stored procedure puts the XML value into a message and send it to SB.</p>
<p>There are two key parts in this stored procedure:</p>
</li>
<li><p>Both inserted and deleted values are formatted as an XML type as SB basically consumes SOAP message format.</p>
</li>
<li><p>A conversation is opened to send the XML message to an external application through SB and EA.</p>
<p>Make sure that the stored procedure only starts conversation and send the message through the conversation. The external application receives the message and processes it and closes the conversation.</p>
<h3 id="Creating-Servie-Broker-Objects"><a href="#Creating-Servie-Broker-Objects" class="headerlink" title="Creating Servie Broker Objects"></a>Creating Servie Broker Objects</h3><p>This is the most important part of this post to setup Service Broker. Consuming SB requires many different entities such as <code>Message Type</code>, <code>Contract</code>, <code>Queue</code>, <code>Service</code> and <code>Event Notification</code>. Now, we are creating those objects in this order &ndash; <code>Message Type</code>, <code>Contract</code>, <code>Queue</code>, <code>Service</code> and <code>Event Notification</code> as they are all dependent on another.</p>
<h4 id="Enable-Service-Broker"><a href="#Enable-Service-Broker" class="headerlink" title="Enable Service Broker"></a>Enable Service Broker</h4><p>As <code>SourceDB</code> is the one to track changes, we need to enable SB on this database. Make sure that this uses <code>ALTER DATABASE</code> statement, which means that all transactions must be completed before executing the <code>ALTER</code> statement. However, for some databases, this might not be possible. In this case, like below, put additional clause, <code>WITH ROLLBACK IMMEDIATE</code>. By doing this, any transaction at the instance of running <code>ALTER DATABASE</code> statement will be rolled back.</p>
<pre>`IF EXISTS (SELECT * FROM sys.databases WHERE name = 'SourceDB' AND is_broker_enabled = 0)
BEGIN
    ALTER DATABASE [SourceDB] SET NEW_BROKER WITH ROLLBACK IMMEDIATE
END
GO
`</pre>

<h4 id="Mesage-Type"><a href="#Mesage-Type" class="headerlink" title="Mesage Type"></a><code>Mesage Type</code></h4><p>We have two message types &ndash; request and response. They define how messages are formed.</p>
<pre>`CREATE MESSAGE TYPE [TrackingRequest]
    VALIDATION = WELL_FORMED_XML
GO

CREATE MESSAGE TYPE [TrackingResponse]
    VALIDATION = NONE    
GO
`</pre>

<h4 id="Contract"><a href="#Contract" class="headerlink" title="Contract"></a><code>Contract</code></h4><p>Both message types are bunched in a contract.</p>
<pre>`CREATE CONTRACT [TrackingContract] (
    [TrackingRequest]   SENT BY INITIATOR, 
    [TrackingResponse]  SENT BY TARGET
    )
GO
`</pre>

<p>Even though, this is not the exact simile, it is easy to understand that <code>INITIATOR</code> is a message sender and <code>TARGET</code> is a message receiver.</p>
<p><a name="queue"></a></p>
<h4 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a><code>Queue</code></h4><p>Messages are stored in queues before being consumed by services.</p>
<pre>`CREATE QUEUE [TrackingRequestQueue]
    WITH
        STATUS = ON,
        RETENTION = OFF
    ON [PRIMARY]
GO

CREATE QUEUE [TrackingResponseQueue]
    WITH 
        STATUS = ON,
        RETENTION = OFF
    ON [PRIMARY]
GO

CREATE QUEUE [TrackingNotificationQueue]
    WITH
        STATUS = ON,
        RETENTION = OFF 
    ON [PRIMARY]
GO
`</pre>

<p>Each queue takes responsibility for each message types. Wait. There is another queue, <code>TrackingNotificationQueue</code> , doesn’t belong to either request nor response. This queue will be consumed by EA, which will be explained later on.</p>
<p><a name="service"></a></p>
<h4 id="Service"><a href="#Service" class="headerlink" title="Service"></a><code>Service</code></h4><p>Services manage queues which a contract combines.</p>
<pre>`CREATE SERVICE [TrackingInitiatorService]
    ON QUEUE [TrackingResponseQueue] ([TrackingContract])
GO

CREATE SERVICE [TrackingTargetService]
    ON QUEUE [TrackingRequestQueue] ([TrackingContract])
GO

CREATE SERVICE [TrackingNotificationService]
    ON QUEUE [TrackingNotificationQueue] ([http://schemas.microsoft.com/SQL/Notifications/PostEventNotification])
GO
`</pre>

<p>There are three distinctive services. One for INITIATOR (sender) and another for TARGET (receiver) and the other for EA. Please bear in mind that sender looks after the <strong>RESPONSE</strong> queue and receiver takes care of the <strong>REQUEST</strong> queue. Both request service and response service are bundled by a contract, while <code>TrackingNotificationService</code> uses default event notification contract.</p>
<p><a name="event-notification"></a></p>
<h4 id="Event-Notification"><a href="#Event-Notification" class="headerlink" title="Event Notification"></a><code>Event Notification</code></h4><p>We have created all necessary message types, contracts, queues and services. Now, we need to create an event notification to throw messages to EA.</p>
<pre>`CREATE EVENT NOTIFICATION [TrackingEventNotification]
    ON QUEUE [TrackingRequestQueue]
    FOR QUEUE_ACTIVATION
    TO SERVICE 'TrackingNotificationService', 'current database'
GO
`</pre>

<p>This raises an event as soon as a message is loaded on the queue, <code>TrackingRequestQueue</code>, and activated. At the same time, the event lets the service, <code>TrackingNotificationService</code>, know the EA starts processing the message. When the EA application receives this event notification, it looks for <code>TrackingRequestQueue</code> if there is a message contracted as <code>TrackingRequest</code> or not.</p>
<p>Let’s go back to the stored procedure we created above. The stored procedure sends a message, <code>TrackingRequest</code>, which is stored in <code>TrackingRequestQueue</code>. This queue is consumed by <code>TrackingTargetService</code>. As stated above, the <code>TrackingTargetService</code> is a receiver, so a conversation is opened within the stored procedure, then the receiver sends a signal to EA to process the message.</p>
<h3 id="Creating-Triggers"><a href="#Creating-Triggers" class="headerlink" title="Creating Triggers"></a>Creating Triggers</h3><p>We’ve created databases, tables, stored procedures and SB objects. Now, we are creating triggers to get what the changes are.</p>
<pre>`CREATE TRIGGER [dbo].[trg_INS_Products]
    ON [dbo].[Products]
    AFTER INSERT
AS
BEGIN

    SET NOCOUNT ON

    DECLARE @productId      AS INT
    DECLARE @trackingType   AS NVARCHAR(8)
    DECLARE @inserted       AS XML
    DECLARE @deleted        AS XML

    SELECT  @productId      = ProductId FROM inserted
    SET     @trackingType   = 'INSERT'
    SET     @inserted       = (SELECT * FROM inserted FOR XML PATH(''), ROOT('Row'), ELEMENTS)
    SET     @deleted        = NULL

    EXECUTE [dbo].[usp_SendTrackingRequest] @productId, @trackingType, @inserted, @deleted

END
GO

CREATE TRIGGER [dbo].[trg_UPD_Products]
    ON [dbo].[Products]
    AFTER UPDATE
AS
BEGIN

    SET NOCOUNT ON

    DECLARE @productId      AS INT
    DECLARE @trackingType   AS NVARCHAR(8)
    DECLARE @inserted       AS XML
    DECLARE @deleted        AS XML

    SELECT  @productId      = ProductId FROM inserted
    SET     @trackingType   = 'UPDATE'
    SET     @inserted       = (SELECT * FROM inserted FOR XML PATH(''), ROOT('Row'), ELEMENTS)
    SET     @deleted        = (SELECT * FROM deleted FOR XML PATH(''), ROOT('Row'), ELEMENTS)

    EXECUTE [dbo].[usp_SendTrackingRequest] @productId, @trackingType, @inserted, @deleted

END
GO

CREATE TRIGGER [dbo].[trg_DEL_Products]
    ON [dbo].[Products]
    AFTER DELETE
AS
BEGIN

    SET NOCOUNT ON

    DECLARE @productId      AS INT
    DECLARE @trackingType   AS NVARCHAR(8)
    DECLARE @inserted       AS XML
    DECLARE @deleted        AS XML

    SELECT  @productId      = ProductId FROM deleted
    SET     @trackingType   = 'DELETE'
    SET     @inserted       = NULL
    SET     @deleted        = (SELECT * FROM deleted FOR XML PATH(''), ROOT('Row'), ELEMENTS)

    EXECUTE [dbo].[usp_SendTrackingRequest] @productId, @trackingType, @inserted, @deleted

END
GO
`</pre>

<p>For more readability, triggers for <code>INSERT</code>, <code>UPDATE</code> and <code>DELETE</code> are separated. They do the literally the same job &ndash; To find a record affected, wrap the record as an XML format and send the record to the stored procedure we created above.</p>
<h3 id="Granting-Permissions"><a href="#Granting-Permissions" class="headerlink" title="Granting Permissions"></a>Granting Permissions</h3><p>For Windows 7, Windows Server 2008 or later, you might have heard of the term, <strong>Virtual Account</strong>. This is not a real account but to work as like a service account in Windows 7, Windows Server 2008 or later which is not on Active Directory. As we have already installed Service Broker External Activator Service, we have a virtual account, <code>NT SERVICE\SSBExternalActivator</code>. This account has already been assigned to the Windows Service application.</p>
<p><img src="http://blob.devkimchi.com/devkimchiwp/2014/11/SSBEAS.Install.03.png" alt=""></p>
<p>Permissions need to be granted onto two accounts &ndash; <code>NT SERVICE\SSBExternalActivator</code> and <code>NT AUTHORITY\ANONYMOUS LOGON</code>. As the former is a virtual account, it actually doesn’t exist. Therefore, in order to access to database, it instead uses the latter. Keep this in your mind. Of course, for your production purpose, it would be better to create a service account.</p>
<p><pre>`USE [master]<br>GO</pre></p>
<p>IF NOT EXISTS (SELECT * FROM sys.syslogins WHERE name = ‘NT SERVICESSBExternalActivator’)<br>BEGIN</p>
<pre><code>CREATE LOGIN [NT SERVICESSBExternalActivator] FROM WINDOWS
</code></pre><p>END<br>GO</p>
<p>USE [TrackingDB]<br>GO</p>
<p>IF NOT EXISTS (SELECT * FROM sys.sysusers WHERE name = ‘NT SERVICESSBExternalActivator’)<br>BEGIN</p>
<pre><code>CREATE USER [NT SERVICESSBExternalActivator] FOR LOGIN [NT SERVICESSBExternalActivator]
</code></pre><p>END<br>GO</p>
<p>ALTER ROLE [db_owner] ADD MEMBER [NT SERVICESSBExternalActivator]<br>GO</p>
<p>USE [SourceDB]<br>GO</p>
<p>IF NOT EXISTS (SELECT * FROM sys.sysusers WHERE name = ‘NT SERVICESSBExternalActivator’)<br>BEGIN</p>
<pre><code>CREATE USER [NT SERVICESSBExternalActivator] FOR LOGIN [NT SERVICESSBExternalActivator]
</code></pre><p>END<br>GO</p>
<p>ALTER ROLE [db_owner] ADD MEMBER [NT SERVICESSBExternalActivator]<br>GO</p>
<p>– Allows CONNECT to [SourceDB].<br>GRANT CONNECT</p>
<pre><code>TO [NT SERVICESSBExternalActivator]
</code></pre><p>GO</p>
<p>– Allows RECEIVE from the queue for the external actvator app.<br>GRANT RECEIVE</p>
<pre><code>ON [TrackingNotificationQueue]
TO [NT SERVICESSBExternalActivator]
</code></pre><p>GO</p>
<p>– Allows VIEW DEFINITION right on the service for the external activator app.<br>GRANT VIEW DEFINITION</p>
<pre><code>ON SERVICE::[TrackingNotificationService]
TO [NT SERVICESSBExternalActivator]
</code></pre><p>GO</p>
<p>– Allows REFRENCES right on the queue schema for the external activator app.<br>GRANT REFERENCES</p>
<pre><code>ON SCHEMA::dbo
TO [NT SERVICESSBExternalActivator]
</code></pre><p>GO</p>
<p>USE [master]<br>GO</p>
<p>IF NOT EXISTS (SELECT * FROM sys.syslogins WHERE name = ‘NT AUTHORITYANONYMOUS LOGON’)<br>BEGIN</p>
<pre><code>CREATE LOGIN [NT AUTHORITYANONYMOUS LOGON] FROM WINDOWS
</code></pre><p>END</p>
<p>USE [TrackingDB]<br>GO</p>
<p>IF NOT EXISTS (SELECT * FROM sys.sysusers WHERE name = ‘NT AUTHORITYANONYMOUS LOGON’)<br>BEGIN</p>
<pre><code>CREATE USER [NT AUTHORITYANONYMOUS LOGON] FOR LOGIN [NT AUTHORITYANONYMOUS LOGON]
</code></pre><p>END<br>GO</p>
<p>ALTER ROLE [db_owner] ADD MEMBER [NT AUTHORITYANONYMOUS LOGON]<br>GO</p>
<p>USE [SourceDB]<br>GO</p>
<p>IF NOT EXISTS (SELECT * FROM sys.sysusers WHERE name = ‘NT AUTHORITYANONYMOUS LOGON’)<br>BEGIN</p>
<pre><code>CREATE USER [NT AUTHORITYANONYMOUS LOGON] FOR LOGIN [NT AUTHORITYANONYMOUS LOGON]
</code></pre><p>END<br>GO</p>
<p>ALTER ROLE [db_owner] ADD MEMBER [NT AUTHORITYANONYMOUS LOGON]<br>GO</p>
<p>– Allows CONNECT to [SourceDB].<br>GRANT CONNECT</p>
<pre><code>TO [NT AUTHORITYANONYMOUS LOGON]
</code></pre><p>GO</p>
<p>– Allows RECEIVE from the queue for the external actvator app.<br>GRANT RECEIVE</p>
<pre><code>ON [TrackingNotificationQueue]
TO [NT AUTHORITYANONYMOUS LOGON]
</code></pre><p>GO</p>
<p>– Allows VIEW DEFINITION right on the service for the external activator app.<br>GRANT VIEW DEFINITION</p>
<pre><code>ON SERVICE::[TrackingNotificationService]
TO [NT AUTHORITYANONYMOUS LOGON]
</code></pre><p>GO</p>
<p>– Allows REFRENCES right on the queue schema for the external activator app.<br>GRANT REFERENCES</p>
<pre><code>ON SCHEMA::dbo
TO [NT AUTHORITYANONYMOUS LOGON]
</code></pre><p>GO</p>
</li>
</ul>
<p>The scripts above give permissions to both <code>NT SERVICE\SSBExternalActivator</code> and <code>NT AUTHORITY\ANONYMOUS LOGON</code> to access to <code>TrackingNotificationService</code> and <code>TrackingNotificationQueue</code>. By granting permissions like this, the EA application can receive messages from SB.</p>
<hr>
<p>So far, we have created service broker objects. In the next post, <a href="http://devkimchi.com/891/service-broker-external-activator-for-sql-server-step-by-step-3/">Step 3: External Activator Application Development</a>, we will develop an application to consume the messages sent from SB.</p>

        </div>
        <footer class="article-footer">
            


    <div class="a2a_kit a2a_default_style">
    <a class="a2a_dd" href="https://www.addtoany.com/share">Share</a>
    <span class="a2a_divider"></span>
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_google_plus"></a>
    <a class="a2a_button_pinterest"></a>
    <a class="a2a_button_tumblr"></a>
</div>
<script type="text/javascript" src="//static.addtoany.com/menu/page.js"></script>
<style>
    .a2a_menu {
        border-radius: 4px;
    }
    .a2a_menu a {
        margin: 2px 0;
        font-size: 14px;
        line-height: 16px;
        border-radius: 4px;
        color: inherit !important;
        font-family: 'Microsoft Yahei';
    }
    #a2apage_dropdown {
        margin: 10px 0;
    }
    .a2a_mini_services {
        padding: 10px;
    }
    a.a2a_i,
    i.a2a_i {
        width: 122px;
        line-height: 16px;
    }
    a.a2a_i .a2a_svg,
    a.a2a_more .a2a_svg {
        width: 16px;
        height: 16px;
        line-height: 16px;
        vertical-align: top;
        background-size: 16px;
    }
    a.a2a_i {
        border: none !important;
    }
    a.a2a_menu_show_more_less {
        margin: 0;
        padding: 10px 0;
        line-height: 16px;
    }
    .a2a_mini_services:after{content:".";display:block;height:0;clear:both;visibility:hidden}
    .a2a_mini_services{*+height:1%;}
</style>


        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>

                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>follow:</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="twitter" href="https://twitter.com/devkimchi" target="_blank">
                        <i class="icon fa fa-twitter"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="facebook" href="https://facebook.com/devkimchi" target="_blank">
                        <i class="icon fa fa-facebook"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/devkimchi" target="_blank">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="linkedin" href="https://linkedin.com/company/dev-kimchi" target="_blank">
                        <i class="icon fa fa-linkedin"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="rss" href="/atom.xml" target="_blank">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2014/11/09/service-broker-external-activator-for-sql-server-step-by-step-3/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption">newer</strong>
        <p class="article-nav-title">
        
            Service Broker External Activator for SQL Server Step by Step #3
        
        </p>
        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
    
    
        <a href="/2014/11/08/service-broker-external-activator-for-sql-server-step-by-step-1/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">older</strong>
        <p class="article-nav-title">Service Broker External Activator for SQL Server Step by Step #1</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                
    <div class="widget-wrap">
        <h3 class="widget-title">recents</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2016/07/20/how-to-use-bower-to-manage-front-end-library-in-visual-studio-2015-for-beginners/" class="thumbnail">
    
    
        <span style="background-image:url(http://www.moneystock.net/wp_e/wp-content/uploads/2016/07/bower2.jpg)" alt="How to use bower to manage front-end library in Visual Studio 2015 : for beginners" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Uncategorized/">Uncategorized</a></p>
                            <p class="item-title"><a href="/2016/07/20/how-to-use-bower-to-manage-front-end-library-in-visual-studio-2015-for-beginners/" class="title">How to use bower to manage front-end library in Visual Studio 2015 : for beginners</a></p>
                            <p class="item-date"><time datetime="2016-07-20T12:02:03.000Z" itemprop="datePublished">2016-07-20</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2016/06/09/building-dotnet-core-application-on-amazon-linux/" class="thumbnail">
    
    
        <span style="background-image:url(http://blob.devkimchi.com/devkimchiwp/2016/06/installing-mono-into-amazon-linux-02.png)" alt="Building .NET Core Application on Amazon Linux" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Uncategorized/">Uncategorized</a></p>
                            <p class="item-title"><a href="/2016/06/09/building-dotnet-core-application-on-amazon-linux/" class="title">Building .NET Core Application on Amazon Linux</a></p>
                            <p class="item-date"><time datetime="2016-06-08T23:00:09.000Z" itemprop="datePublished">2016-06-09</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2016/06/08/installing-mono-into-amazon-linux/" class="thumbnail">
    
    
        <span style="background-image:url(http://blob.devkimchi.com/devkimchiwp/2016/06/installing-mono-into-amazon-linux-01.png)" alt="Installing Mono into Amazon Linux" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Uncategorized/">Uncategorized</a></p>
                            <p class="item-title"><a href="/2016/06/08/installing-mono-into-amazon-linux/" class="title">Installing Mono into Amazon Linux</a></p>
                            <p class="item-date"><time datetime="2016-06-07T23:00:26.000Z" itemprop="datePublished">2016-06-08</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2016/06/07/entity-framewoork-core-data-migration-through-kudu/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Uncategorized/">Uncategorized</a></p>
                            <p class="item-title"><a href="/2016/06/07/entity-framewoork-core-data-migration-through-kudu/" class="title">Entity Framework Core Data Migration through KUDU</a></p>
                            <p class="item-date"><time datetime="2016-06-06T23:00:46.000Z" itemprop="datePublished">2016-06-07</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2016/06/06/long-path-error-while-publishing-aspnet-core-rc1-applications/" class="thumbnail">
    
    
        <span style="background-image:url(http://blob.devkimchi.com/devkimchiwp/2016/06/long-path-exception-01.png)" alt="Long Path Error While Publishing ASP.NET Core RC1 Applications" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Uncategorized/">Uncategorized</a></p>
                            <p class="item-title"><a href="/2016/06/06/long-path-error-while-publishing-aspnet-core-rc1-applications/" class="title">Long Path Error While Publishing ASP.NET Core RC1 Applications</a></p>
                            <p class="item-date"><time datetime="2016-06-05T23:00:45.000Z" itemprop="datePublished">2016-06-06</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">tag cloud</h3>
        <div class="widget tagcloud">
            <a href="/tags/NET-Core/" style="font-size: 10px;">.NET Core</a> <a href="/tags/API-Management/" style="font-size: 10px;">API Management</a> <a href="/tags/ARM/" style="font-size: 10px;">ARM</a> <a href="/tags/ASP-NET-5/" style="font-size: 10px;">ASP.NET 5</a> <a href="/tags/ASP-NET-Core/" style="font-size: 12.5px;">ASP.NET Core</a> <a href="/tags/ASP-NET-MVC/" style="font-size: 10px;">ASP.NET MVC</a> <a href="/tags/ASP-NET-MVC-6/" style="font-size: 10px;">ASP.NET MVC 6</a> <a href="/tags/AWS-Lambda/" style="font-size: 10px;">AWS Lambda</a> <a href="/tags/Amazon-Linux/" style="font-size: 12.5px;">Amazon Linux</a> <a href="/tags/AngularJS/" style="font-size: 10px;">AngularJS</a> <a href="/tags/App-Only/" style="font-size: 10px;">App-Only</a> <a href="/tags/Atlas/" style="font-size: 10px;">Atlas</a> <a href="/tags/Authentication/" style="font-size: 10px;">Authentication</a> <a href="/tags/Auto-Loading/" style="font-size: 10px;">Auto Loading</a> <a href="/tags/AutoRest/" style="font-size: 10px;">AutoRest</a> <a href="/tags/Autofac/" style="font-size: 15px;">Autofac</a> <a href="/tags/Automation/" style="font-size: 10px;">Automation</a> <a href="/tags/Azure/" style="font-size: 12.5px;">Azure</a> <a href="/tags/Azure-Resource-Manager/" style="font-size: 10px;">Azure Resource Manager</a> <a href="/tags/Azure-SQL/" style="font-size: 12.5px;">Azure SQL</a> <a href="/tags/BizTalk/" style="font-size: 15px;">BizTalk</a> <a href="/tags/Bower/" style="font-size: 12.5px;">Bower</a> <a href="/tags/CDATA/" style="font-size: 10px;">CDATA</a> <a href="/tags/CLR-Assembly/" style="font-size: 10px;">CLR Assembly</a> <a href="/tags/CQRS-Pattern/" style="font-size: 10px;">CQRS Pattern</a> <a href="/tags/Cloud-Design-Pattern/" style="font-size: 10px;">Cloud Design Pattern</a> <a href="/tags/Configurability/" style="font-size: 10px;">Configurability</a> <a href="/tags/CrmSvcUtil-exe/" style="font-size: 10px;">CrmSvcUtil.exe</a> <a href="/tags/DI/" style="font-size: 10px;">DI</a> <a href="/tags/Data-Migration/" style="font-size: 10px;">Data Migration</a> <a href="/tags/DataAnnotations/" style="font-size: 10px;">DataAnnotations</a> <a href="/tags/Dependency-Injection/" style="font-size: 12.5px;">Dependency Injection</a> <a href="/tags/Deserialisation/" style="font-size: 10px;">Deserialisation</a> <a href="/tags/DevOps/" style="font-size: 10px;">DevOps</a> <a href="/tags/Dynamics-CRM/" style="font-size: 10px;">Dynamics CRM</a> <a href="/tags/Dynamics-CRM-Online/" style="font-size: 10px;">Dynamics CRM Online</a> <a href="/tags/Email/" style="font-size: 10px;">Email</a> <a href="/tags/Entity-Context-Library/" style="font-size: 10px;">Entity Context Library</a> <a href="/tags/Entity-Framework/" style="font-size: 12.5px;">Entity Framework</a> <a href="/tags/Event-Sourcing-Pattern/" style="font-size: 10px;">Event Sourcing Pattern</a> <a href="/tags/Extensibility/" style="font-size: 10px;">Extensibility</a> <a href="/tags/Extensions/" style="font-size: 10px;">Extensions</a> <a href="/tags/External-Activator/" style="font-size: 17.5px;">External Activator</a> <a href="/tags/Filtering/" style="font-size: 10px;">Filtering</a> <a href="/tags/Flexibility/" style="font-size: 10px;">Flexibility</a> <a href="/tags/Fluent-API/" style="font-size: 10px;">Fluent API</a> <a href="/tags/FluentValidation/" style="font-size: 10px;">FluentValidation</a> <a href="/tags/ForEach/" style="font-size: 10px;">ForEach</a> <a href="/tags/GROUP-BY/" style="font-size: 10px;">GROUP BY</a> <a href="/tags/Global-Exception-Handling/" style="font-size: 10px;">Global Exception Handling</a> <a href="/tags/Graph-API/" style="font-size: 10px;">Graph API</a> <a href="/tags/Grunt/" style="font-size: 10px;">Grunt</a> <a href="/tags/Gulp/" style="font-size: 12.5px;">Gulp</a> <a href="/tags/HAL/" style="font-size: 10px;">HAL</a> <a href="/tags/HAVING/" style="font-size: 10px;">HAVING</a> <a href="/tags/Integration/" style="font-size: 10px;">Integration</a> <a href="/tags/Inversion-of-Control/" style="font-size: 10px;">Inversion of Control</a> <a href="/tags/IoC/" style="font-size: 12.5px;">IoC</a> <a href="/tags/JSON-Web-Token/" style="font-size: 10px;">JSON Web Token</a> <a href="/tags/JWT/" style="font-size: 10px;">JWT</a> <a href="/tags/KUDU/" style="font-size: 10px;">KUDU</a> <a href="/tags/LESS/" style="font-size: 10px;">LESS</a> <a href="/tags/LINQ/" style="font-size: 10px;">LINQ</a> <a href="/tags/Logic-Apps/" style="font-size: 10px;">Logic Apps</a> <a href="/tags/MS-SQL/" style="font-size: 10px;">MS-SQL</a> <a href="/tags/MVC/" style="font-size: 10px;">MVC</a> <a href="/tags/Microsoft-Graph/" style="font-size: 10px;">Microsoft Graph</a> <a href="/tags/Module/" style="font-size: 10px;">Module</a> <a href="/tags/Mono/" style="font-size: 12.5px;">Mono</a> <a href="/tags/O365/" style="font-size: 10px;">O365</a> <a href="/tags/Office-365/" style="font-size: 10px;">Office 365</a> <a href="/tags/Parallel/" style="font-size: 10px;">Parallel</a> <a href="/tags/PathTooLongException/" style="font-size: 10px;">PathTooLongException</a> <a href="/tags/Plugins/" style="font-size: 10px;">Plugins</a> <a href="/tags/PowerShell/" style="font-size: 15px;">PowerShell</a> <a href="/tags/Quartz-NET/" style="font-size: 10px;">Quartz.NET</a> <a href="/tags/RC1/" style="font-size: 10px;">RC1</a> <a href="/tags/REST-API/" style="font-size: 10px;">REST API</a> <a href="/tags/ReCaptcha-NET/" style="font-size: 10px;">ReCaptcha.NET</a> <a href="/tags/Resource-Group/" style="font-size: 10px;">Resource Group</a> <a href="/tags/SELECT/" style="font-size: 10px;">SELECT</a> <a href="/tags/SQL/" style="font-size: 10px;">SQL</a> <a href="/tags/SQL-Server/" style="font-size: 20px;">SQL Server</a> <a href="/tags/Serialisation/" style="font-size: 10px;">Serialisation</a> <a href="/tags/Service-Broker/" style="font-size: 17.5px;">Service Broker</a> <a href="/tags/Session/" style="font-size: 10px;">Session</a> <a href="/tags/SharePoint/" style="font-size: 10px;">SharePoint</a> <a href="/tags/Swagger/" style="font-size: 12.5px;">Swagger</a> <a href="/tags/Swashbuckle/" style="font-size: 10px;">Swashbuckle</a> <a href="/tags/Testability/" style="font-size: 12.5px;">Testability</a> <a href="/tags/Tips-amp-Tricks/" style="font-size: 10px;">Tips &amp; Tricks</a> <a href="/tags/TypeScript/" style="font-size: 10px;">TypeScript</a> <a href="/tags/Visual-Studio/" style="font-size: 10px;">Visual Studio</a> <a href="/tags/Visual-Studio-2013/" style="font-size: 10px;">Visual Studio 2013</a> <a href="/tags/WCF/" style="font-size: 10px;">WCF</a> <a href="/tags/WHERE/" style="font-size: 10px;">WHERE</a> <a href="/tags/Web-API/" style="font-size: 12.5px;">Web API</a> <a href="/tags/Windows-API-Code-Pack/" style="font-size: 10px;">Windows API Code Pack</a> <a href="/tags/Windows-Service/" style="font-size: 10px;">Windows Service</a> <a href="/tags/XML/" style="font-size: 12.5px;">XML</a> <a href="/tags/asp-net/" style="font-size: 10px;">asp.net</a> <a href="/tags/concourrency/" style="font-size: 10px;">concourrency</a> <a href="/tags/node-js/" style="font-size: 12.5px;">node.js</a> <a href="/tags/npm/" style="font-size: 12.5px;">npm</a> <a href="/tags/reCaptcha/" style="font-size: 10px;">reCaptcha</a> <a href="/tags/visual-studio-2015/" style="font-size: 10px;">visual studio 2015</a> <a href="/tags/vs-2015/" style="font-size: 10px;">vs 2015</a>
        </div>
    </div>


            
        
    </div>
</aside>
                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2016 DevKimchi</p>
                <p>Powered by <a href="//hexo.io/" target="_blank">Hexo</a>. Theme by <a href="//github.com/ppoffice" target="_blank">PPOffice</a></p>
            </div>
        </div>
    </div>
</footer>
        
    
    <script>
    var disqus_shortname = 'devkimchi';
    
    
    var disqus_url = 'http://devkimchi.com/2014/11/08/service-broker-external-activator-for-sql-server-step-by-step-2/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>



    
        <script src="/vendor/lightgallery/js/lightgallery.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-pager.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-hash.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-share.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-video.min.js"></script>
    


<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>
